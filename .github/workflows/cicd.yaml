name : cicd Pipeline

on : push

jobs:
  Testing:
    runs-on : ubuntu-latest

    steps:
    - name : Checkout code
      uses : actions/checkout@v4

    - name : Set up Python
      uses : actions/setup-python@v5
      with :
        python-version : '3.11'
        cache : 'pip' 

    - name : Install dependencies
      run : |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: DVC Pull Data
      env:
        DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: dvc pull

    - name: Test Model Registry
      env:
        DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        pytest tests/test_model_registry.py

    - name: Test Model Performance
      env:
        DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        pytest tests/test_model_performance.py

    - name: Promote Model
      if: success()
      env:
        DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        python scripts/promote_model_to_prod.py
        